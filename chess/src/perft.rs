use crate::position::Position;

/// Count the number of nodes at a given depth
#[must_use]
pub fn perft(pos: &Position, depth: i32) -> u64 {
    if depth == 0 {
        return 1;
    }

    let mut nodes = 0;

    for mv in pos.pseudolegal_moves() {
        let mut npos = *pos;
        let success = npos.makemove(&mv);
        if !success {
            continue;
        }

        nodes += perft(&npos, depth - 1);
    }

    nodes
}

#[cfg(test)]
mod tests {
    use super::*;

    static TESTS: [(&str, [u64; 3]); 171] = [
        (
            "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
            [20, 400, 8902],
        ),
        (
            "r3k2r/p1ppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq - 0 1",
            [48, 2039, 97862],
        ),
        ("4k3/8/8/8/8/8/8/4K2R w K - 0 1", [15, 66, 1197]),
        ("4k3/8/8/8/8/8/8/R3K3 w Q - 0 1", [16, 71, 1287]),
        ("4k2r/8/8/8/8/8/8/4K3 w k - 0 1", [5, 75, 459]),
        ("r3k3/8/8/8/8/8/8/4K3 w q - 0 1", [5, 80, 493]),
        ("4k3/8/8/8/8/8/8/R3K2R w KQ - 0 1", [26, 112, 3189]),
        ("r3k2r/8/8/8/8/8/8/4K3 w kq - 0 1", [5, 130, 782]),
        ("8/8/8/8/8/8/6k1/4K2R w K - 0 1", [12, 38, 564]),
        ("8/8/8/8/8/8/1k6/R3K3 w Q - 0 1", [15, 65, 1018]),
        ("4k2r/6K1/8/8/8/8/8/8 w k - 0 1", [3, 32, 134]),
        ("r3k3/1K6/8/8/8/8/8/8 w q - 0 1", [4, 49, 243]),
        ("r3k2r/8/8/8/8/8/8/R3K2R w KQkq - 0 1", [26, 568, 13744]),
        ("r3k2r/8/8/8/8/8/8/1R2K2R w Kkq - 0 1", [25, 567, 14095]),
        ("r3k2r/8/8/8/8/8/8/2R1K2R w Kkq - 0 1", [25, 548, 13502]),
        ("r3k2r/8/8/8/8/8/8/R3K1R1 w Qkq - 0 1", [25, 547, 13579]),
        ("1r2k2r/8/8/8/8/8/8/R3K2R w KQk - 0 1", [26, 583, 14252]),
        ("2r1k2r/8/8/8/8/8/8/R3K2R w KQk - 0 1", [25, 560, 13592]),
        ("r3k1r1/8/8/8/8/8/8/R3K2R w KQq - 0 1", [25, 560, 13607]),
        ("4k3/8/8/8/8/8/8/4K2R b K - 0 1", [5, 75, 459]),
        ("4k3/8/8/8/8/8/8/R3K3 b Q - 0 1", [5, 80, 493]),
        ("4k2r/8/8/8/8/8/8/4K3 b k - 0 1", [15, 66, 1197]),
        ("r3k3/8/8/8/8/8/8/4K3 b q - 0 1", [16, 71, 1287]),
        ("4k3/8/8/8/8/8/8/R3K2R b KQ - 0 1", [5, 130, 782]),
        ("r3k2r/8/8/8/8/8/8/4K3 b kq - 0 1", [26, 112, 3189]),
        ("8/8/8/8/8/8/6k1/4K2R b K - 0 1", [3, 32, 134]),
        ("8/8/8/8/8/8/1k6/R3K3 b Q - 0 1", [4, 49, 243]),
        ("4k2r/6K1/8/8/8/8/8/8 b k - 0 1", [12, 38, 564]),
        ("r3k3/1K6/8/8/8/8/8/8 b q - 0 1", [15, 65, 1018]),
        ("r3k2r/8/8/8/8/8/8/R3K2R b KQkq - 0 1", [26, 568, 13744]),
        ("r3k2r/8/8/8/8/8/8/1R2K2R b Kkq - 0 1", [26, 583, 14252]),
        ("r3k2r/8/8/8/8/8/8/2R1K2R b Kkq - 0 1", [25, 560, 13592]),
        ("r3k2r/8/8/8/8/8/8/R3K1R1 b Qkq - 0 1", [25, 560, 13607]),
        ("1r2k2r/8/8/8/8/8/8/R3K2R b KQk - 0 1", [25, 567, 14095]),
        ("2r1k2r/8/8/8/8/8/8/R3K2R b KQk - 0 1", [25, 548, 13502]),
        ("r3k1r1/8/8/8/8/8/8/R3K2R b KQq - 0 1", [25, 547, 13579]),
        ("8/1n4N1/2k5/8/8/5K2/1N4n1/8 w - - 0 1", [14, 195, 2760]),
        ("8/1k6/8/5N2/8/4n3/8/2K5 w - - 0 1", [11, 156, 1636]),
        ("8/8/4k3/3Nn3/3nN3/4K3/8/8 w - - 0 1", [19, 289, 4442]),
        ("K7/8/2n5/1n6/8/8/8/k6N w - - 0 1", [3, 51, 345]),
        ("k7/8/2N5/1N6/8/8/8/K6n w - - 0 1", [17, 54, 835]),
        ("8/1n4N1/2k5/8/8/5K2/1N4n1/8 b - - 0 1", [15, 193, 2816]),
        ("8/1k6/8/5N2/8/4n3/8/2K5 b - - 0 1", [16, 180, 2290]),
        ("8/8/3K4/3Nn3/3nN3/4k3/8/8 b - - 0 1", [4, 68, 1118]),
        ("K7/8/2n5/1n6/8/8/8/k6N b - - 0 1", [17, 54, 835]),
        ("k7/8/2N5/1N6/8/8/8/K6n b - - 0 1", [3, 51, 345]),
        ("B6b/8/8/8/2K5/4k3/8/b6B w - - 0 1", [17, 278, 4607]),
        ("8/8/1B6/7b/7k/8/2B1b3/7K w - - 0 1", [21, 316, 5744]),
        ("k7/B7/1B6/1B6/8/8/8/K6b w - - 0 1", [21, 144, 3242]),
        ("K7/b7/1b6/1b6/8/8/8/k6B w - - 0 1", [7, 143, 1416]),
        ("B6b/8/8/8/2K5/5k2/8/b6B b - - 0 1", [6, 106, 1829]),
        ("8/8/1B6/7b/7k/8/2B1b3/7K b - - 0 1", [17, 309, 5133]),
        ("k7/B7/1B6/1B6/8/8/8/K6b b - - 0 1", [7, 143, 1416]),
        ("K7/b7/1b6/1b6/8/8/8/k6B b - - 0 1", [21, 144, 3242]),
        ("7k/RR6/8/8/8/8/rr6/7K w - - 0 1", [19, 275, 5300]),
        ("R6r/8/8/2K5/5k2/8/8/r6R w - - 0 1", [36, 1027, 29215]),
        ("7k/RR6/8/8/8/8/rr6/7K b - - 0 1", [19, 275, 5300]),
        ("R6r/8/8/2K5/5k2/8/8/r6R b - - 0 1", [36, 1027, 29227]),
        ("6kq/8/8/8/8/8/8/7K w - - 0 1", [2, 36, 143]),
        ("6KQ/8/8/8/8/8/8/7k b - - 0 1", [2, 36, 143]),
        ("K7/8/8/3Q4/4q3/8/8/7k w - - 0 1", [6, 35, 495]),
        ("6qk/8/8/8/8/8/8/7K b - - 0 1", [22, 43, 1015]),
        ("6KQ/8/8/8/8/8/8/7k b - - 0 1", [2, 36, 143]),
        ("K7/8/8/3Q4/4q3/8/8/7k b - - 0 1", [6, 35, 495]),
        ("8/8/8/8/8/K7/P7/k7 w - - 0 1", [3, 7, 43]),
        ("8/8/8/8/8/7K/7P/7k w - - 0 1", [3, 7, 43]),
        ("K7/p7/k7/8/8/8/8/8 w - - 0 1", [1, 3, 12]),
        ("7K/7p/7k/8/8/8/8/8 w - - 0 1", [1, 3, 12]),
        ("8/2k1p3/3pP3/3P2K1/8/8/8/8 w - - 0 1", [7, 35, 210]),
        ("8/8/8/8/8/K7/P7/k7 b - - 0 1", [1, 3, 12]),
        ("8/8/8/8/8/7K/7P/7k b - - 0 1", [1, 3, 12]),
        ("K7/p7/k7/8/8/8/8/8 b - - 0 1", [3, 7, 43]),
        ("7K/7p/7k/8/8/8/8/8 b - - 0 1", [3, 7, 43]),
        ("8/2k1p3/3pP3/3P2K1/8/8/8/8 b - - 0 1", [5, 35, 182]),
        ("8/8/8/8/8/4k3/4P3/4K3 w - - 0 1", [2, 8, 44]),
        ("4k3/4p3/4K3/8/8/8/8/8 b - - 0 1", [2, 8, 44]),
        ("8/8/7k/7p/7P/7K/8/8 w - - 0 1", [3, 9, 57]),
        ("8/8/k7/p7/P7/K7/8/8 w - - 0 1", [3, 9, 57]),
        ("8/8/3k4/3p4/3P4/3K4/8/8 w - - 0 1", [5, 25, 180]),
        ("8/3k4/3p4/8/3P4/3K4/8/8 w - - 0 1", [8, 61, 483]),
        ("8/8/3k4/3p4/8/3P4/3K4/8 w - - 0 1", [8, 61, 411]),
        ("k7/8/3p4/8/3P4/8/8/7K w - - 0 1", [4, 15, 90]),
        ("8/8/7k/7p/7P/7K/8/8 b - - 0 1", [3, 9, 57]),
        ("8/8/k7/p7/P7/K7/8/8 b - - 0 1", [3, 9, 57]),
        ("8/8/3k4/3p4/3P4/3K4/8/8 b - - 0 1", [5, 25, 180]),
        ("8/3k4/3p4/8/3P4/3K4/8/8 b - - 0 1", [8, 61, 411]),
        ("8/8/3k4/3p4/8/3P4/3K4/8 b - - 0 1", [8, 61, 483]),
        ("k7/8/3p4/8/3P4/8/8/7K b - - 0 1", [4, 15, 89]),
        ("7k/3p4/8/8/3P4/8/8/K7 w - - 0 1", [4, 19, 117]),
        ("7k/8/8/3p4/8/8/3P4/K7 w - - 0 1", [5, 19, 116]),
        ("k7/8/8/7p/6P1/8/8/K7 w - - 0 1", [5, 22, 139]),
        ("k7/8/7p/8/8/6P1/8/K7 w - - 0 1", [4, 16, 101]),
        ("k7/8/8/6p1/7P/8/8/K7 w - - 0 1", [5, 22, 139]),
        ("k7/8/6p1/8/8/7P/8/K7 w - - 0 1", [4, 16, 101]),
        ("k7/8/8/3p4/4p3/8/8/7K w - - 0 1", [3, 15, 84]),
        ("k7/8/3p4/8/8/4P3/8/7K w - - 0 1", [4, 16, 101]),
        ("7k/3p4/8/8/3P4/8/8/K7 b - - 0 1", [5, 19, 117]),
        ("7k/8/8/3p4/8/8/3P4/K7 b - - 0 1", [4, 19, 117]),
        ("k7/8/8/7p/6P1/8/8/K7 b - - 0 1", [5, 22, 139]),
        ("k7/8/7p/8/8/6P1/8/K7 b - - 0 1", [4, 16, 101]),
        ("k7/8/8/6p1/7P/8/8/K7 b - - 0 1", [5, 22, 139]),
        ("k7/8/6p1/8/8/7P/8/K7 b - - 0 1", [4, 16, 101]),
        ("k7/8/8/3p4/4p3/8/8/7K b - - 0 1", [5, 15, 102]),
        ("k7/8/3p4/8/8/4P3/8/7K b - - 0 1", [4, 16, 101]),
        ("7k/8/8/p7/1P6/8/8/7K w - - 0 1", [5, 22, 139]),
        ("7k/8/p7/8/8/1P6/8/7K w - - 0 1", [4, 16, 101]),
        ("7k/8/8/1p6/P7/8/8/7K w - - 0 1", [5, 22, 139]),
        ("7k/8/1p6/8/8/P7/8/7K w - - 0 1", [4, 16, 101]),
        ("k7/7p/8/8/8/8/6P1/K7 w - - 0 1", [5, 25, 161]),
        ("k7/6p1/8/8/8/8/7P/K7 w - - 0 1", [5, 25, 161]),
        ("3k4/3pp3/8/8/8/8/3PP3/3K4 w - - 0 1", [7, 49, 378]),
        ("7k/8/8/p7/1P6/8/8/7K b - - 0 1", [5, 22, 139]),
        ("7k/8/p7/8/8/1P6/8/7K b - - 0 1", [4, 16, 101]),
        ("7k/8/8/1p6/P7/8/8/7K b - - 0 1", [5, 22, 139]),
        ("7k/8/1p6/8/8/P7/8/7K b - - 0 1", [4, 16, 101]),
        ("k7/7p/8/8/8/8/6P1/K7 b - - 0 1", [5, 25, 161]),
        ("k7/6p1/8/8/8/8/7P/K7 b - - 0 1", [5, 25, 161]),
        ("3k4/3pp3/8/8/8/8/3PP3/3K4 b - - 0 1", [7, 49, 378]),
        ("8/Pk6/8/8/8/8/6Kp/8 w - - 0 1", [11, 97, 887]),
        ("n1n5/1Pk5/8/8/8/8/5Kp1/5N1N w - - 0 1", [24, 421, 7421]),
        ("8/PPPk4/8/8/8/8/4Kppp/8 w - - 0 1", [18, 270, 4699]),
        ("n1n5/PPPk4/8/8/8/8/4Kppp/5N1N w - - 0 1", [24, 496, 9483]),
        ("8/Pk6/8/8/8/8/6Kp/8 b - - 0 1", [11, 97, 887]),
        ("n1n5/1Pk5/8/8/8/8/5Kp1/5N1N b - - 0 1", [24, 421, 7421]),
        ("8/PPPk4/8/8/8/8/4Kppp/8 b - - 0 1", [18, 270, 4699]),
        ("n1n5/PPPk4/8/8/8/8/4Kppp/5N1N b - - 0 1", [24, 496, 9483]),
        // EP
        ("8/8/8/8/1k1PpN1R/8/8/4K3 b - d3 0 1", [9, 193, 1322]),
        ("8/8/8/8/1k1Ppn1R/8/8/4K3 b - d3 0 1", [17, 220, 3001]),
        ("4k3/8/8/2PpP3/8/8/8/4K3 w - d6 0 1", [9, 47, 376]),
        ("4k3/8/8/8/2pPp3/8/8/4K3 b - d3 0 1", [9, 47, 376]),
        // EP - pinned diagonal
        ("4k3/b7/8/2Pp4/8/8/8/6K1 w - d6 0 1", [5, 45, 285]),
        ("4k3/7b/8/4pP2/8/8/8/1K6 w - e6 0 1", [5, 45, 285]),
        ("6k1/8/8/8/2pP4/8/B7/3K4 b - d3 0 1", [5, 45, 285]),
        ("1k6/8/8/8/4Pp2/8/7B/4K3 b - e3 0 1", [5, 45, 285]),
        ("4k3/b7/8/1pP5/8/8/8/6K1 w - b6 0 1", [6, 52, 324]),
        ("4k3/7b/8/5Pp1/8/8/8/1K6 w - g6 0 1", [6, 51, 318]),
        ("6k1/8/8/8/1Pp5/8/B7/4K3 b - b3 0 1", [6, 52, 324]),
        ("1k6/8/8/8/5pP1/8/7B/4K3 b - g3 0 1", [6, 51, 318]),
        ("4k3/K7/8/1pP5/8/8/8/6b1 w - b6 0 1", [6, 66, 370]),
        ("4k3/7K/8/5Pp1/8/8/8/1b6 w - g6 0 1", [6, 60, 296]),
        ("6B1/8/8/8/1Pp5/8/k7/4K3 b - b3 0 1", [6, 66, 370]),
        ("1B6/8/8/8/5pP1/8/7k/4K3 b - g3 0 1", [6, 60, 296]),
        ("4k3/b7/8/2Pp4/3K4/8/8/8 w - d6 0 1", [5, 44, 310]),
        ("4k3/8/1b6/2Pp4/3K4/8/8/8 w - d6 0 1", [6, 59, 438]),
        ("4k3/8/b7/1Pp5/2K5/8/8/8 w - c6 0 1", [6, 49, 371]),
        ("4k3/8/7b/5pP1/5K2/8/8/8 w - f6 0 1", [6, 49, 367]),
        ("4k3/7b/8/4pP2/4K3/8/8/8 w - e6 0 1", [5, 44, 310]),
        ("4k3/8/6b1/4pP2/4K3/8/8/8 w - e6 0 1", [6, 53, 393]),
        ("4k3/8/3K4/1pP5/8/q7/8/8 w - b6 0 1", [5, 114, 622]),
        ("7k/4K3/8/1pP5/8/q7/8/8 w - b6 0 1", [8, 171, 991]),
        // EP - double check
        ("4k3/2rn4/8/2K1pP2/8/8/8/8 w - e6 0 1", [4, 75, 335]),
        // EP - pinned horizontal
        ("4k3/8/8/K2pP2r/8/8/8/8 w - d6 0 1", [6, 94, 640]),
        ("4k3/8/8/K2pP2q/8/8/8/8 w - d6 0 1", [6, 130, 857]),
        ("4k3/8/8/r2pP2K/8/8/8/8 w - d6 0 1", [6, 87, 605]),
        ("4k3/8/8/q2pP2K/8/8/8/8 w - d6 0 1", [6, 129, 858]),
        ("8/8/8/8/1k1Pp2R/8/8/4K3 b - d3 0 1", [8, 125, 869]),
        ("8/8/8/8/1R1Pp2k/8/8/4K3 b - d3 0 1", [6, 87, 605]),
        // EP - pinned vertical
        ("k7/8/4r3/3pP3/8/8/8/4K3 w - d6 0 1", [5, 70, 497]),
        ("k3K3/8/8/3pP3/8/8/8/4r3 w - d6 0 1", [6, 91, 633]),
        // EP - in check
        ("4k3/8/8/4pP2/3K4/8/8/8 w - e6 0 1", [9, 49, 364]),
        ("8/8/8/4k3/5Pp1/8/8/3K4 b - f3 0 1", [9, 50, 374]),
        // EP - block check
        ("4k3/8/K6r/3pP3/8/8/8/8 w - d6 0 1", [6, 109, 584]),
        ("4k3/8/K6q/3pP3/8/8/8/8 w - d6 0 1", [6, 151, 803]),
        // Double check
        ("4k3/8/4r3/8/8/8/3p4/4K3 w - - 0 1", [4, 80, 320]),
        ("4k3/8/4q3/8/8/8/3b4/4K3 w - - 0 1", [4, 143, 496]),
        // Pins
        ("4k3/8/8/8/1b5b/8/3Q4/4K3 w - - 0 1", [3, 54, 1256]),
        ("4k3/8/8/8/1b5b/8/3R4/4K3 w - - 0 1", [3, 54, 836]),
        ("4k3/8/8/8/1b5b/2Q5/5P2/4K3 w - - 0 1", [6, 98, 2274]),
        ("4k3/8/8/8/1b5b/2R5/5P2/4K3 w - - 0 1", [4, 72, 1300]),
        ("4k3/8/8/8/1b2r3/8/3Q4/4K3 w - - 0 1", [3, 66, 1390]),
        ("4k3/8/8/8/1b2r3/8/3QP3/4K3 w - - 0 1", [6, 119, 2074]),
    ];

    #[test]
    fn test_perft() {
        for (fen, results) in TESTS {
            let pos = Position::from_fen(fen);

            for (depth, expected) in results.iter().enumerate() {
                let nodes = perft(&pos, depth as i32 + 1);
                assert_eq!(
                    nodes,
                    *expected,
                    "perft fail: depth {} {} vs {} for {}",
                    depth + 1,
                    nodes,
                    expected,
                    fen
                );
            }
        }
    }
}
